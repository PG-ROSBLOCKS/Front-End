name: Deploy Angular to EC2
on:
  push:
    branches: [ aws-tests ]

env:
  NODE_VERSION: 20.x   # sigue usando en CI para tareas de sed/lint, no para el build

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prep-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # Sustituye la IP del backend en CodeService
      - name: Inject DEPLOY_HOST in API_CONTAINER_IP
        run: |
          HOST="${{ secrets.DEPLOY_HOST }}"
          FILE="ROSBLOCKS/src/app/services/code.service.ts"
          sed -i -E \
            "s~(API_CONTAINER_IP\\s*=\\s*['\"]).*(['\"])~\\1${HOST}\\2~" \
            "$FILE"

      # Empaquetamos TODO el repo como artefacto
      - uses: actions/upload-artifact@v4
        with:
          name: rosblocks-source
          path: .

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-on-ec2:
    needs: prep-config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: rosblocks-source
          path: .

      # Copiamos todo el repositorio al servidor
      - name: Upload repo to EC2 and build there
        uses: easingthemes/ssh-deploy@v2.1.4
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          REMOTE_HOST:     ${{ secrets.DEPLOY_HOST }}
          REMOTE_USER:     ${{ secrets.DEPLOY_USER }}
          REMOTE_PORT:     ${{ secrets.DEPLOY_PORT }}
          SOURCE:          "."                # todo el repo
          TARGET:          "/home/ubuntu/ROSBLOCKS"
          ARGS:            "--delete"

          # 1) Construye el proyecto Angular
          # 2) Copia dist/ a /angular (directorio que atiende NGINX)
          # 3) Reinicia NGINX
          #    â€“ ajusta rutas segÃºn tu estructura
          SCRIPT_AFTER: |
            set -e
            cd /home/ubuntu/ROSBLOCKS/ROSBLOCKS    # raÃ­z del proyecto Angular

            # (Opcional) instala Node + Angular CLI si aÃºn no existen
            # source ~/.nvm/nvm.sh && nvm install 20 && nvm use 20
            # npm i -g @angular/cli

            echo "ğŸ›   Installing dependenciesâ€¦"
            npm ci --include=dev

            echo "ğŸ—  Building Angularâ€¦"
            npx ng build --configuration production --output-path dist

            echo "ğŸšš  Deploying bundle to /angularâ€¦"
            sudo rm -rf /angular/*
            sudo cp -r dist/* /angular/

            echo "ğŸ”„  Restarting NGINXâ€¦"
            sudo systemctl restart nginx

            echo "âœ…  Deployment finished"
